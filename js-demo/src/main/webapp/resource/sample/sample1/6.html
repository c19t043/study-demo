<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <!--<link rel="stylesheet" href="../../lib/bootstrap-3.3.7-dist/css/bootstrap.css">-->
    <link rel="stylesheet" href="../../lib/sweetAlert2/sweetalert2.min.css">
    <style>
        .box {
            margin: 0 auto;
            width: 1200px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .title_box {
            position: relative;
            background: #c1c1c1;
        }

        .title {
            display: inline-block;
            padding: 20px;
            font-size: 20px;
            line-height: 20px;
        }

        .box button {
            position: absolute;
            right: 30px;
            top: 15px;
            padding: 8px 10px;
            border: 0;
            outline: 0;
            background: #f6f6f6;
            cursor: pointer;
        }

        .MenuPanel {
            position: relative;
            width: 100%;
            padding-bottom: 20px;
        }

        .MenuTitle {
            font-size: 18px;
            padding-left: 30px;
            padding-top: 10px;
            padding-bottom: 14px;
            background: #ccc;
            cursor: pointer;
        }

        .MenuBtn {
            position: absolute;
            right: 140px;
            top: 6px;
            padding: 8px 10px;
            border: 0;
            outline: 0;
            background: #f6f6f6;
            cursor: pointer;
        }

        .icon {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: url("select.png") no-repeat;
            background-size: 10px 10px;
            margin-right: 10px;
        }

        .del {
            position: absolute;
            right: -14px;
            top: 10px;
            display: inline-block;
            width: 30px;
            height: 30px;
            background: url("del.png") no-repeat;
            background-size: 30px 30px;
            cursor: pointer;
        }

        .MenuContent {
            background: #DCDCDC;
        }

        .secondPanel, .ThirdPanel {
            position: relative;
        }

        .secondTitle {
            padding-left: 60px;
            padding-top: 10px;
            padding-bottom: 14px;
            cursor: pointer;
        }

        /* 二级抽屉及以下删除按钮 */
        .del_2,
        .del_3,
        .del_4,
        .del1_1,
        .del2_2,
        .del3_3,
        .del4_4 {
            position: absolute;
            right: -14px;
            top: 8px;
            display: inline-block;
            width: 30px;
            height: 30px;
            background: url("del.png") no-repeat;
            background-size: 30px 30px;
            cursor: pointer;
        }

        /* 二级抽屉及以下增加按钮 */
        .btn2,
        .btn3,
        .btn4,
        .btn1_1,
        .btn2_2,
        .btn3_3,
        .btn4_4 {
            position: absolute;
            right: 140px;
            top: 6px;
            padding: 8px 10px;
            border: 0;
            outline: 0;
            background: #f6f6f6;
            cursor: pointer;
        }

        .ThirdTitle {
            padding-left: 90px;
            padding-top: 10px;
            padding-bottom: 14px;
            cursor: pointer;
        }

        .ThirdContent {
            width: 700px;
            margin: 0 auto;
            overflow: hidden;
        }

        .edition {
            position: relative;
            width: 140px;
            height: 40px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 10px;
            text-align: center;
            line-height: 40px;
            float: left;
            margin-right: 30px;
            margin-bottom: 10px;
        }

        .edition:nth-child(4n) {
            margin-right: 0;
        }

        .del_edt {
            position: absolute;
            right: -14px;
            top: 8px;
            display: inline-block;
            width: 30px;
            height: 30px;
            background: url("del.png") no-repeat;
            background-size: 30px 30px;
            cursor: pointer;
        }

        /*.swal2-popup .swal2-header {*/
            /*align-items: end;*/
            /*background-color: #c1c1c1;*/
            /*border-top-left-radius: 10px;*/
        /*}*/

        /*.swal2-popup, .swal2-modal, .swal2-show {*/
            /*padding: 0px;*/
            /*border-top-left-radius: 20px;*/
        /*}*/

        /*#swal2-title {*/
            /*padding-left: 20px;*/
        /*}*/

        /*#swal2-content {*/
            /*padding-top: 20px;*/
        /*}*/

        /*.swal2-popup .swal2-close {*/
            /*color: black;*/
        /*}*/
    </style>
</head>
<body>
<div class="box">
    <div class="title_box">
        <div class="title">分类列表</div>
        <button parentId="0" level="0" classifyId="0" class="addClassify">+增加一级分类</button>
    </div>

    <!-- 1 -->
    <!--<div class="MenuPanel">-->
        <!--<div class="MenuTitle">-->
            <!--<i class="icon"></i>学前教育-->
        <!--</div>-->
        <!--<button class="MenuBtn">+增加二级分类</button>-->
        <!--<i class="del"></i>-->
        <!--&lt;!&ndash; 二级抽屉 &ndash;&gt;-->
        <!--<div class="MenuContent">-->
            <!--<div class="secondPanel">-->
                <!--<div class="secondTitle">-->
                    <!--<i class="icon"></i>初一-->
                <!--</div>-->
                <!--<button class="btn2">+增加三级分类</button>-->
                <!--<i class="del_2"></i>-->
                <!--<div class="secondContent">-->
                    <!--&lt;!&ndash; 三级抽屉 &ndash;&gt;-->
                    <!--<div class="ThirdPanel">-->
                        <!--<div class="ThirdTitle">-->
                            <!--<i class="icon"></i>语文-->
                        <!--</div>-->
                        <!--<button class="btn1_1">+增加四级分类</button>-->
                        <!--<i class="del1_1"></i>-->
                        <!--<div class="ThirdContent">-->
                            <!--<div class="edition"><i class="del_edt"></i>人教版</div>-->
                            <!--<div class="edition"><i class="del_edt"></i>苏教版</div>-->
                            <!--<div class="edition"><i class="del_edt"></i>美教版</div>-->
                            <!--<div class="edition"><i class="del_edt"></i>中教版</div>-->
                            <!--<div class="edition"><i class="del_edt"></i>人教新版</div>-->
                        <!--</div>-->
                    <!--</div>-->
                <!--</div>-->
            <!--</div>-->
        <!--</div>-->
    <!--</div>-->
</div>
</body>

<script src="../../lib/jquery/jquery-1.9.1.min.js"></script>
<script src="../../lib/sweetAlert2/sweetalert2.all.min.js"></script>
<!--<script src="../../lib/bootstrap-3.3.7-dist/js/bootstrap.js"></script>-->
<script type="text/javascript">
    var base = "http://localhost:8080/ukplatform";

    $(document).ready(function () {
        $(".addClassify").on("click",addClassify);
        initClassifyList(data);
        hideAllContent();
    });

    function hideAllContent(){
        $(".icon").parent().siblings("div").hide();
        $(".icon").css("transform", "rotateZ(180deg)");
    }

    function hideChildContent(obj){
        $(obj).parent().find(".icon").parent().siblings("div").hide();
        $(obj).parent().find(".icon").css("transform", "rotateZ(180deg)");
    }


    function bindFoldFunction(obj){
        if($(obj).attr("classifyId") === "0"){
            $(obj).parent().siblings("div").last().children(".fold").on("click", foldClassify);
        }else{
            $(obj).siblings("div").children("div:last").children(".fold").on("click", foldClassify);
        }
    }

    function foldClassify(){
        if($(this).siblings("div").css("display") === "none"){
            $(this).children(".icon").css("transform", "rotateZ(0deg)");
            $(this).siblings("div").show();
            $(this).siblings("div").css("display","");
        }else{
            hideChildContent(this);
        }
    }

    var data = [{
        id: 1,
        level: 1,
        name: "测试一级分类1",
        parentId: 0,
        children: [{
            id: 2,
            level: 2,
            name: "测试二级分类1",
            parentId: 1,
            children: [{
                id: 3,
                level: 3,
                name: "测试三级分类1",
                parentId: 2,
                children: [{
                    id: 4,
                    level: 4,
                    name: "测试四级分类1",
                    parentId: 3,
                    children: []
                },{
                    id: 5,
                    level: 4,
                    name: "测试四级分类2",
                    parentId: 3,
                    children: []
                },{
                    id: 6,
                    level: 4,
                    name: "测试四级分类3",
                    parentId: 3,
                    children: []
                }]
            }]
        }]
    }, {
        id: 7,
        level: 1,
        name: "测试一级分类2",
        parentId: 0,
        children: [{
            id: 8,
            level: 2,
            name: "测试二级分类1",
            parentId: 7,
            children: [{
                id: 9,
                level: 3,
                name: "测试三级分类1",
                parentId: 8,
                children: [{
                    id: 10,
                    level: 4,
                    name: "测试四级分类1",
                    parentId: 9,
                    children: []
                },{
                    id: 11,
                    level: 4,
                    name: "测试四级分类2",
                    parentId: 9,
                    children: []
                },{
                    id: 12,
                    level: 4,
                    name: "测试四级分类3",
                    parentId: 9,
                    children: []
                }]
            }]
        }]
    }];

    function initClassifyList(dataArr){
        if(dataArr.length > 0){
            $.each(dataArr,function(index,classifyVO){
                var $addBtn;
                if(classifyVO.parentId === "0"){
                    $addBtn = $(".addClassify[parentId='"+classifyVO.parentId+"']");
                }else{
                    $addBtn = $(".addClassify[classifyId='"+classifyVO.parentId+"']");
                }
                addClassifyWithCommon($addBtn[0],classifyVO.parentId,
                    classifyVO.level,
                    classifyVO.id,
                    classifyVO.name)
                if(classifyVO.children.length > 0){
                    initClassifyList(classifyVO.children);
                }
                if(id < classifyVO.id){
                    id = classifyVO.id + 1;
                }
            })
            // console.log(id);
        }
    }

    var level2LevelZh = [0,"一","二","三","四"];
    var id = 1;

    function bindDelClassify(obj) {
        if($(obj).attr("classifyId") === "0"){
            $(obj).parent().siblings("div").last().children(".custom_del").on("click", delClassify);
        }else{
            $(obj).siblings("div").children("div:last").children(".custom_del").on("click", delClassify);
        }
        // $(".custom_del").on("click", delClassify);
    }

    function delClassify() {
        Swal.fire({
            title: '提示',
            html: '删除该分类后，课程将不允许添加到该分类，是否继续删除？',
            showCloseButton: true,
            showCancelButton: true,
            reverseButtons: true,
            confirmButtonText: "删除",
            cancelButtonText: "取消"
        }).then((result) => {
            if(result.value){
                var parentId = $(this).attr("parentId");
                var level = parseInt($(this).attr("level"));
                var classifyId = $(this).attr("classifyId");
                var classifyName = $(this).attr("classifyName");
                if(validateExistChildClassify(parentId,level,classifyId)){
                    Swal.fire({
                        title: '提示',
                        html: '该分类下，还有子分类，请先移除子分类后，再删除',
                        confirmButtonText: "好的"
                    })
                }else{
                    if(delClassifyWithSyncAjax(classifyId)){
                        delClassifyFrom_classifyDB(parentId,classifyId,classifyName);
                        $(this).parent().remove();
                    }else{
                        Swal.fire({
                            type: 'error',
                            title: '操作失败！'
                        })
                    }
                }
            }
        })
    }

    // ajax同步删除课程分类
    function delClassifyWithSyncAjax(classifyId){
        return true;
    }

    // 校验要删除的分类下是否存在子分类
    function validateExistChildClassify(parentId,level,classifyId) {
        var flag = false;
        switch (level){
            case 1:
            case 2:
            case 3:
                if(classifyDB_all[classifyId].length > 0){
                    flag = true;
                }
        }
        return flag;
    }

    function delClassifyFrom_classifyDB(parentId,classifyId,classifyName) {
        if(parentId=== "0"){
            classifyDB_all.default_top_level.splice(classifyDB_all.default_top_level.indexOf(classifyName),1);
        }else{
            classifyDB_all[parentId].splice(classifyDB_all[parentId].indexOf(classifyName),1);
        }
        delete classifyDB_all[classifyId];
    }


    function bindAddClassify(obj) {
        if($(obj).attr("classifyId") === "0"){
            $(obj).parent().siblings("div").last().children(".addClassify").on("click", addClassify);
        }else{
            $(obj).siblings("div").children("div:last").children(".addClassify").on("click", addClassify);
        }
    }

    function addClassify(){
        //父级分类id
        var parentId = $(this).attr("parentId");
        var parentLevel = parseInt($(this).attr("level"));
        if(parentLevel !== 0) parentId = $(this).attr("classifyId");
        var curLevel = parentLevel + 1;
        var levelName = level2LevelZh[curLevel];
        Swal.fire({
            title: '新增' + levelName + '级分类',
            html:
            '分类名称：' +
            '<input type="text" id="classifyName" style="width: 250px; height:30px"> ',
            showCloseButton: true,
            showCancelButton: true,
            reverseButtons: true,
            confirmButtonText: "确定",
            cancelButtonText: "取消"
        }).then((result) => {
            if(result.value) {
            var curClassifyName = $("#classifyName").val();
            if(!validateBeforeAdd(parentId,curLevel,curClassifyName)){
                return;
            }
            var classifyId = addClassifyWithSyncAjax(parentId,curLevel,curClassifyName);
            if(classifyId){
                addClassifyWithCommon(this,parentId,curLevel,classifyId,curClassifyName);
                Swal.fire({
                    type: 'success',
                    title: '操作成功！',
                    timer: 1500
                })
            }else{
                Swal.fire({
                    type: 'error',
                    title: '操作失败！'
                })
            }
        }
    })
    }

    function addClassifyWithCommon(obj,parentId,level,classifyId,classifyName){
        var classifyHTML = madeClassifyHTML(parentId,level,classifyId,classifyName);
        insertClassifyHTML(obj,classifyHTML,level);
        addClassifyName2ClassifyDB(parentId,level,classifyId,classifyName)
        bindAddClassify(obj);
        bindDelClassify(obj);
        bindFoldFunction(obj);
    }

    // 异步添加课程分类:返回classifyId
    function addClassifyWithSyncAjax(parentId,curLevel,curClassifyName){
        var classifyId = id;
        id++;
        return classifyId;
    }

    var classifyDB_all = {"default_top_level":[]};
    // 分类存储课程分类名 并判断同level下是否存在相同值

    // 添加前，校验参数是否能通过
    function validateBeforeAdd(parentId,level,classifyName){
        var flag = true;
        if(!classifyName){
            flag = false;
            Swal.fire({
                title: '提示',
                html: '课程分类名不能为空',
                confirmButtonText: "好的"
            })
        }
        else if(validateDuplicateClassifyName(parentId,level,classifyName)){
            flag = false;
            Swal.fire({
                title: '提示',
                html: '该分类已有课程使用，请修改课程分类后，再删除',
                confirmButtonText: "好的"
            })
        }
        return flag;
    }

    // 验证分类名同level下存在相同名
    function validateDuplicateClassifyName(parentId,level,classifyName){
        var arr;
        switch(level){
            case 1: arr = classifyDB_all.default_top_level;break;
            case 2:
            case 3:
            case 4: arr = classifyDB_all[parentId];
        }
        var flag = false;
        $.each(arr,function (index,value) {
            if(value === classifyName){
                flag = true;
                return true;
            }
        });
        return flag;
    }

    // 添加到classifyDB
    function addClassifyName2ClassifyDB(parentId,level,classifyId,classifyName){
        var arr;
        switch(level){
            case 1: arr = classifyDB_all.default_top_level;break;
            case 2:
            case 3:
            case 4: arr = classifyDB_all[parentId];
        }
        arr.push(classifyName);
        classifyDB_all[classifyId]=[];
    }

    // 插入分类html标签
    function insertClassifyHTML(obj,classifyHTML,level){
        // 增加一级分类
        switch(level){
            // > div:last-child
            case 1: $(".box").append(classifyHTML); break;
            case 2: $(obj).siblings("."+classifyMap[level-1].content).append(classifyHTML);break;
            case 3: $(obj).siblings("."+classifyMap[level-1].content).append(classifyHTML);break;
            case 4: $(obj).siblings("."+classifyMap[level-1].content).append(classifyHTML);break;
        }
    }
    // 制作分类标签
    var classifyMap = [0,{panel:"MenuPanel",title:"MenuTitle",button:"MenuBtn",del:"del",content:"MenuContent"},
        {panel:"secondPanel",title:"secondTitle",button:"btn2",del:"del_2",content:"secondContent"},
        {panel:"ThirdPanel",title:"ThirdTitle",button:"btn1_1",del:"del1_1",content:"ThirdContent"}];
    function madeClassifyHTML(parentId,level,classifyId,classifyName){
        switch (level){
            case 1:
            case 2:
            case 3:
                var classifyStyle = classifyMap[level];
                return '<div class="'+classifyStyle.panel+'">'+
                            '<div class="'+classifyStyle.title+' fold">'+
                                '<i class="icon"></i>'+classifyName+
                            '</div>'+
                            '<button class="addClassify '+classifyStyle.button+'" parentId="'+parentId+'" level="'+level+'" classifyId="'+classifyId+'">+增加'+level2LevelZh[level+1]+'级分类</button>'+
                            '<i class="'+classifyStyle.del+' custom_del" ' +
                                    'parentId="'+parentId+'" level="'+level+'" classifyId="'+classifyId+'" classifyName="'+classifyName+'"></i>'+
                            '<div class="'+classifyStyle.content+'">'+
                            '</div>'+
                        '</div>';
            case 4 : return '<div class="edition"><i class="del_edt custom_del" ' +
                                    'parentId="'+parentId+'" level="'+level+'" classifyId="'+classifyId+'" classifyName="'+classifyName+'"></i>'+classifyName+'</div>';
            /*            case 1 :  '<div class="MenuPanel">'+
                                        '<div class="MenuTitle">'+
                                            '<i class="icon"></i>'+classifyName+
                                        '</div>'+
                                        ' <button class="MenuBtn" parentId="'+parentId+'" level="'+(level++)+'" classifyId="'+classifyId+'" class="addClassify">+增加二级分类</button>'+
                                        '<i class="del"></i>'+
                                        <!-- 二级抽屉 -->
                                        '<div class="MenuContent">'+
                                        '</div>'+
                                    '</div>';
                        case 2 : '<div class="secondPanel">'+
                                        '<div class="secondTitle">'+
                                            '<i class="icon"></i>'+classifyName+
                                        '</div>'+
                                        '<button class="btn2" parentId="0" level="0" classifyId="0" class="addClassify">+增加三级分类</button>'+
                                        '<i class="del_2"></i>'+
                                        '<div class="secondContent">'+
                                        '</div>'+
                                    '</div>';
                        case 3 :  '<div class="ThirdPanel">'+
                                        '<div class="ThirdTitle">'+
                                            '<i class="icon"></i>'+classifyName+
                                        '</div>'+
                                        '<button class="btn1_1" parentId="0" level="0" classifyId="0" class="addClassify">+增加四级分类</button>'+
                                        '<i class="del1_1"></i>'+
                                        '<div class="ThirdContent">'+
                                        '</div>'+
                                    '</div>';*/
        }
    }
</script>

</html>